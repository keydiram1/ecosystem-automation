version: '3'
env:
  PROJECT_ID: "ecosystem-connectors-data"
  REGION: "me-west1"
  ZONE: "me-west1-a"
  BUCKET_NAME: "ecosys-workspace-vars"
  COMMON_VARS: "{{ .TASKFILE_DIR }}/common_vars.yaml"
tasks:

  plan:
    cmds:
      - task common-vars:download -- {{ .CLI_ARGS }}
      - terragrunt run-all plan
  apply:
    cmds:
      - task common-vars:upload
      - terragrunt run-all apply --terragrunt-non-interactive
  destroy:
    cmds:
      - task plan  -- {{ .CLI_ARGS }}
      - terragrunt run-all destroy --terragrunt-non-interactive
  clean:
    cmds:
      - find . \( -type d -name ".terragrunt-cache" -o -name ".terraform" \) -prune -exec rm -rf {} +
      - find . -type f -name ".terraform.lock.hcl" -exec rm -f {} +
      - find . -maxdepth 1 -type f \( -name "*.pem" -o -name "*.jks" \) -exec rm -f {} +
      - find . -type f -exec sh -c 'head -n 1 "{}" | grep -q "^# Generated by Terragrunt" && rm -f "{}"' \;
  common-vars:upload:
    cmds:
      - "{{.ROOT_DIR}}/scripts/common_vars.py --upload"
  common-vars:download:
    cmds:
      - "{{.ROOT_DIR}}/scripts/common_vars.py --download {{ .CLI_ARGS }}"
